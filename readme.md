# Eagle Reports PDF Extractor

This project is designed to extract and process specific data from PDF reports generated by the Eagle system. The extracted data is then uploaded to a SharePoint site for further use.

## Purpose

The purpose of this codebase is to automate the extraction of important pages and reportable data from various Eagle PDF reports. The extracted data is then uploaded to a SharePoint site for storage and further analysis.

## Deployment to Cloudflare Workers

### Prerequisites

- Node.js and npm installed
- Cloudflare account
- Wrangler CLI installed (`npm install -g wrangler`)

### Setup

1. Clone the repository:
    ```sh
    git clone https://github.com/yourusername/eagle-reports-pdf-extractor.git
    cd eagle-reports-pdf-extractor
    ```

2. Install dependencies:
    ```sh
    npm install
    ```

3. Configure `wrangler.json`:
    - Update the `wrangler.json` file with your specific configuration.
    - Ensure the `vars` section contains the correct values for your environment.

    Example `wrangler.json`:
    ```json
    {
      "name": "eagle-reports-pdf-extractor",
      "type": "javascript",
      "workers_dev": false,
      "compatibility_date": "2025-02-28",
      "main": "worker.js",
      "compatibility_flags": [
        "nodejs_compat"
      ],
      "vars": {
        "ID_STRINGS": {
          "EAGLE_RAG_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RAG", "firstPage": "PROGRAMNAME:RAG"},
          "EAGLE_RCAD_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RCAD", "firstPage": "PRELIMINARYPAGEFORCREDITAUTHORIZATIONDETAILREPORT"},
          "EAGLE_RCK_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RCK", "firstPage": "Doc.#Cust#JobName"},
          "EAGLE_RDJ_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RDJ", "firstPage": "PROGRAM-NAME:RDJ"},
          "EAGLE_RDS_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RDS", "firstPage": "PRELIMINARYPAGEFORDAILYSALESTOTALSREPORT"},
          "EAGLE_RTX_ID_STRING": {"originalPreliminary": "SPOOLEDREPORTOF-RTX", "firstPage": "PROGRAM-NAME:RTX"}
        },
        "SHAREPOINT_SITE_NAME": "LumberTradersSalesJournal",
        "SHAREPOINT_DRIVE_NAME": "Documents",
        "SHAREPOINT_STORE_FOLDER_NAMES": "HBS",
        "REPORTABLE_DATA_LOCATORS": [
          {
            "report": "EagleRDJ",
            "data": {
              "arInvoices": {
                "type": "locator",
                "after": "INVOICES",
                "next": {
                  "after": "1040-030",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              },
              "arCredits": {
                "type": "locator",
                "after": "CREDIT MEMOS",
                "next": {
                  "after": "1040-030",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              },
              "arDebit": {
                "type": "derived",
                "depends": ["arInvoices", "arCredits"],
                "calculation": "difference"
              },
              "arCredit": {
                "type": "locator",
                "after": "PAYMENTS",
                "next": {
                  "after": "1040-030",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              },
              "cashOnHand": {
                "type": "locator",
                "after": "PAYMENTS",
                "next": {
                  "after": "1021-030",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              },
              "discountsAndWriteoffs": {
                "type": "locator",
                "after": "PAYMENTS",
                "next": {
                  "after": "6412-030",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              }
            }
          },
          {
            "report": "EagleRDS",
            "data": {
              "taxableMerchandise": {
                "type": "locator",
                "after": "TAXABLE MERCHANDISE",
                "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
              },
              "taxableMerchandiseLessDisc": {
                "type": "locator",
                "after": "** SALES TOTALS **",
                "next": {
                  "after": "TAXABLE MERCH DISC",
                  "pattern": "([0-9,]+\\s*\\.\\s*[0-9]{2})"
                }
              },
              "taxableMerchandiseNet": {
                "type": "derived",
                "depends": ["taxableMerchandise", "taxableMerchandiseLessDisc"],
                "calculation": "difference"
              }
            }
          }
        ]
      },
      "triggers": {
        "crons": [
          "0 13 * * *"
        ] 
      },
      "observability": {
        "enabled": true,
        "head_sampling_rate": 1
      }
    }
    ```

4. Create a `.dev.vars` file with your environment variables:
    ```vars
    "MS_CLIENT_SECRET" = "YOUR CLIENT SECRET FROM AZURE AD"
    "MS_CLIENT_ID": "YOUR CLIENT ID FROM AZURE AD"
    "MS_TENANT_ID": "YOUR TENANT ID FROM AZURE AD"
    ```

5. Publish the worker:
    ```sh
    wrangler publish
    ```

## Usage

The worker is scheduled to run daily at 13:00 UTC. It can also be triggered manually by accessing the worker's URL with the appropriate query parameters.

### Manual Trigger

To manually trigger the worker, navigate to the worker's URL with the following query parameters:
- `performRerun=true`
- `dateas=yyyy-mm-dd`
- `storeCode=STORE_CODE`

Example:
```
https://your-worker-url/?performRerun=true&dateas=2023-10-01&storeCode=HBS
```

This will rerun the extraction process for the specified date and store code.

## License

This project is licensed under the ISC License.
